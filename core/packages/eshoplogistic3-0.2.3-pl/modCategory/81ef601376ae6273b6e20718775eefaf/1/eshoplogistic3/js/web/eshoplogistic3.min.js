const modal_widget=document.getElementById("eShopLogisticWidgetModal"),block_widget=document.getElementById("eShopLogisticWidgetBlock");let widget=null,widgetType=null,widgetReady=!1;function isJSON(e){try{return JSON.parse(e)}catch(t){return!1}}if(modal_widget||block_widget){modal_widget?(widget=modal_widget,widgetType="modal"):(widget=block_widget,widgetType="block");let e=widget.dataset.offers;if(void 0!==e&&(offers=isJSON(e))){if(widgetReady=!0,void 0!==offers[0].count){let t=document.querySelector('.ms2_form input[name="count"]');t&&(t.onchange=function(){offers[0].count=this.value,widget.dataset.offers=JSON.stringify(offers)})}document.addEventListener("change",function(e){let t=e.target.name,i=t.match(/options\[(.*?)\]/);i&&"string"==typeof i[1]&&void 0!==offers[0].options[i[1]]&&(offers[0].options[i[1]].value=e.target.value,widget.dataset.offers=JSON.stringify(offers)),"block"===widgetType&&widget.dispatchEvent(new CustomEvent("eShopLogisticWidgetBlock:updateParamsRequest",{detail:{requestParams:{offers:JSON.stringify(offers)}}}))})}widgetReady||console.log("Виджет не может быть запущен. Проверьте правильность указания data-offers.")}let modalSearchForm={elements:{modal:null},init:function(){null===this.elements.modal&&modalSearchForm.create();let e=this;window.onclick=function(t){t.target==e.elements.modal&&(e.elements.modal.style.display="none")};let t=document.querySelector("#eShopLogisticModal .close");t.onclick=function(){e.elements.modal.style.display="none"},document.querySelector("#eShopLogisticSearch").oninput=function(){this.value.length>=3&&eShopLogistic.selectSettlement(this.value)},document.addEventListener("click",function(t){void 0!==t.target.dataset.fias&&t.target.closest("#eShopLogisticSearchResult")&&(e.elements.modal.style.display="none",eShopLogistic.items.delivery.disabled=!1,eShopLogistic.params.settlement={name:t.target.dataset.name,region:t.target.dataset.region,fias:t.target.dataset.fias,services:t.target.dataset.services},eShopLogistic.setSettlementRegion())})},create:function(){let e=document.body,t=document.createElement("div");t.setAttribute("id","eShopLogisticModal"),t.innerHTML='<div class="modal_container">\n<div class="modal_header">\n   Выберите населённый пункт\n   <span class="close">\xd7</span>\n</div>\n<div class="modal_content">\n   <div class="form-floating"><input type="text" id="eShopLogisticSearch" class="form-control"><label for="eShopLogisticSearch">Поиск по названию</label></div>\n   <hr>\n   <div id="eShopLogisticSearchResult"></div>\n   </div>\n</div>',e.append(t),this.elements.modal=t},setData:function(e){if("object"==typeof e){let t=document.getElementById("eShopLogisticSearchResult");if(t){let i="";for(let s in e)i+='<div class="delivery-region"><p>'+s+"</p><ul>",e[s].forEach(e=>{i+='<li><a class="rank-'+e.rank+'" role="button" data-name="'+e.type+" "+e.name+'" data-region="'+e.region+'" data-fias="'+e.fias+'" data-services='+JSON.stringify(e.services)+">"+e.name+" <span>"+e.type+"</span></a></li>"}),i+="</ul></div>";t.innerHTML=i}}}},eShopLogistic={stateLoad:!1,items:{widget:null,delivery:null,settlement:null,region:null,payments:null,infoBlock:null,defaultDelivery:null},params:{offers:null,payment:null,settlement:null},init:function(){let e=this;if("number"==typeof eshoplogistic3Config.delivery_id){let t=document.getElementById("delivery_"+eshoplogistic3Config.delivery_id);if(t)this.items.delivery=t;else{console.log('Ошибка: на странице отсутствует вариант доставки id="delivery_'+eshoplogistic3Config.delivery_id+'"');return}}else{console.log("Ошибка: в настройках MS2 не включён вариант доставки eShopLogistic");return}if(0!==eshoplogistic3Config.default_delivery_id){let i=document.getElementById("delivery_"+eshoplogistic3Config.default_delivery_id);if(i)this.items.defaultDelivery=i;else{console.log('Ошибка: на странице отсутствует вариант доставки по умолчанию id="delivery_'+eshoplogistic3Config.default_delivery_id+'"');return}}else console.log("Ошибка: в настройках eshoplogistic3 не включён вариант доставки по умолчанию");if(this.items.infoBlock=document.getElementById("eShopLogistic3Info"),this.items.widget=document.getElementById("eShopLogisticWidgetCart"),this.items.payments=JSON.parse(eshoplogistic3Config.payments),this.items.settlement=document.getElementById("city"),this.items.settlement)this.items.settlement.readOnly=!0,this.items.settlement.addEventListener("click",e=>{modalSearchForm.elements.modal.style.display="block"});else{console.log('Ошибка: на странице отсутствует поле выбора населённого пункта id="city"');return}let s=document.getElementById("region");s&&(this.items.region=s,this.items.region.readOnly=!0,this.items.region.addEventListener("click",e=>{modalSearchForm.elements.modal.style.display="block"}));let a="action=geo";"string"==typeof this.items.widget.dataset.target?a+="&target="+this.items.widget.dataset.target:a+="&target="+this.items.settlement.value,"string"==typeof this.items.widget.dataset.region?a+="&region="+this.items.widget.dataset.region:a+="&region="+this.items.region.value,this.request(a).then(t=>{"string"==typeof t.fias?(eShopLogistic.params.settlement={name:t.name,region:t.region,fias:t.fias,services:t.services},this.setSettlementRegion()):(e.items.infoBlock.innerHTML=eshoplogistic3Config.settlement_warning_message,e.items.infoBlock.style.display="block",e.loaders.view("msCart",!1),e.loaders.view("msOrder",!1))});let n=document.querySelectorAll('input[name="delivery"]');n.forEach.call(n,function(t){t.addEventListener("click",t=>{e.run().then()})})},loaders:{items:{msCart:null,msOrder:null},html:'<div class="loader"><div class="spinner-border text-primary" role="status"></div><span>'+eshoplogistic3Config.loading_message+"</span></div>",create:function(e){let t=document.getElementById(e);t.style.position="relative";let i=document.createElement("div");i.classList.add("eShopLogistic3WidgetLoading"),i.innerHTML=this.html,this.items[e]=i,t.append(i)},view:function(e,t){t?null===this.items[e]?this.create(e):this.items[e].style.display="block":null!==this.items[e]&&(this.items[e].style.display="none")}},validate:function(){return null!==this.items.delivery&&!!this.items.delivery.checked},selectSettlement:function(e){this.request("action=search&target="+e).then(e=>{modalSearchForm.setData(e)})},setSettlementRegion:function(){let e=new Event("change");this.items.settlement.value=this.params.settlement.name,this.items.settlement.dispatchEvent(e),null!==this.items.region&&(this.items.region.value=this.params.settlement.region,this.items.region.dispatchEvent(e)),this.run().then()},request:function(e){return fetch(eshoplogistic3Config.actionUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-type":"application/x-www-form-urlencoded"},body:e}).then(e=>e.json())},getPaymentType:function(){let e=document.querySelector("input[name=payment]:checked").id.match(/(\d+)/);if(e[0])for(let[t,i]of Object.entries(this.items.payments))-1!=i.indexOf(e[0])&&(this.params.payment=t)},load:async function(){this.items.widget.dispatchEvent(new CustomEvent("eShopLogisticWidgetCart:loadApp"))},run:async function(){if(this.setDefaultDelivery(!1),this.validate()){document.getElementById("msCart")&&this.loaders.view("msCart",!0),this.loaders.view("msOrder",!0),this.getPaymentType();let e=new Promise((e,t)=>{this.request("action=offers").then(t=>{"object"==typeof t&&e(JSON.stringify(t))})});this.params.offers=await e,console.log(this.params.offers),this.stateLoad||await this.load(),console.log("load"),this.items.widget.style.display="block";let t={offers:this.params.offers,payment:this.params.payment};this.items.widget.dispatchEvent(new CustomEvent("eShopLogisticWidgetCart:updateParamsRequest",{detail:{settlement:this.params.settlement,requestParams:t}}))}else this.items.widget.style.display="none",this.setInfo()},setInfo:function(e="",t={}){let i={},s=!1,a=!1;if(this.items.infoBlock.innerHTML="",this.items.infoBlock.style.display="none",null!==this.items.delivery&&this.items.delivery.checked)switch(e){case"onAllServicesLoaded":s=a=!0,this.items.infoBlock.innerHTML=eshoplogistic3Config.warning_message,this.items.infoBlock.style.display="block",i={event:e};break;case"onSelectedService":s=a=!0,i={event:e,delivery_id:eshoplogistic3Config.delivery_id,settlement:{name:eShopLogistic.params.settlement.name,region:eShopLogistic.params.settlement.region,fias:eShopLogistic.params.settlement.fias},service:{code:t.service.code,name:t.service.name},type:t.typeDelivery,price:{value:t.service.responseData[t.typeDelivery].price.value,unit:t.service.responseData[t.typeDelivery].price.unit},time:{value:t.service.responseData[t.typeDelivery].time.value,unit:t.service.responseData[t.typeDelivery].time.unit,text:t.service.responseData[t.typeDelivery].time.text},comments:{service:t.service.comment??"",type:t.service.responseData[t.typeDelivery].comment??""}},"object"==typeof t.service.responseData[t.typeDelivery].tariff&&(i.tariff=t.service.responseData[t.typeDelivery].tariff),"object"==typeof t.terminal&&(i.terminal={code:t.terminal.code,name:t.terminal.name,address:t.terminal.address,phones:t.terminal.phones,workTime:t.terminal.workTime,lon:t.terminal.lon,lat:t.terminal.lat,is_postamat:t.terminal.is_postamat});break;case"onNotAvailableServices":this.items.infoBlock.innerHTML=eshoplogistic3Config.fail_message,this.items.infoBlock.style.display="block"}s&&this.request("action=delivery&data="+JSON.stringify(i)).then(t=>{a&&miniShop2.Order.getcost(),"string"==typeof t.info&&"onAllServicesLoaded"!=e&&(this.items.infoBlock.innerHTML=t.info,this.items.infoBlock.style.display="block")})},setDefaultDelivery:function(e=!0){e?(this.items.delivery.disabled=!0,this.items.widget.style.display="none",this.items.defaultDelivery.click()):this.items.widget.style.display="block";let t=document.querySelectorAll(".eShopLogistic3NoDelivery");t.forEach.call(t,function(t){t.innerHTML=e?eshoplogistic3Config.no_delivery_message:""})}};document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("eShopLogisticWidgetCart");null!==e&&(modalSearchForm.init(),setTimeout(()=>{eShopLogistic.init(),eShopLogistic.items.widget.addEventListener("eShopLogisticWidgetCart:onNotAvailableServices",e=>{console.log("Событие onNotAvailableServices"),eShopLogistic.setDefaultDelivery(!0),document.getElementById("msCart")&&eShopLogistic.loaders.view("msCart",!1),eShopLogistic.loaders.view("msOrder",!1),eShopLogistic.setInfo("onNotAvailableServices")}),e.addEventListener("eShopLogisticWidgetCart:onLoadApp",e=>{let t={offers:eShopLogistic.params.offers,payment:eShopLogistic.params.payment};null===eShopLogistic.params.payment&&console.log("eShopLogistic: проверьте настройки вариантов оплаты"),eShopLogistic.items.widget.dispatchEvent(new CustomEvent("eShopLogisticWidgetCart:updateParamsRequest",{detail:{settlement:eShopLogistic.params.settlement,requestParams:t}})),eShopLogistic.stateLoad=!0}),e.addEventListener("eShopLogisticWidgetCart:onSelectedService",e=>{eShopLogistic.setInfo("onSelectedService",e.detail)}),e.addEventListener("eShopLogisticWidgetCart:onAllServicesLoaded",e=>{eShopLogistic.setInfo("onAllServicesLoaded"),eShopLogistic.loaders.view("msCart",!1),eShopLogistic.loaders.view("msOrder",!1)}),e.addEventListener("eShopLogisticWidgetCart:onInvalidServices",()=>{console.log("Событие onInvalidServices"),eShopLogistic.setDefaultDelivery(!0),eShopLogistic.loaders.view("msCart",!1),eShopLogistic.loaders.view("msOrder",!1)})},1e3),"undefined"!=typeof miniShop2&&(miniShop2.Callbacks.add("Order.add.response.success","eShopLogistic3OrderAdd",function(e){"string"==typeof e.data.payment&&1==eshoplogistic3Config.payment_on&&setTimeout(function(){eShopLogistic.run().then()},1e3)}),miniShop2.Callbacks.add("Cart.change.response.success","eShopLogistic3CartChange",function(e){eShopLogistic.run().then()}),miniShop2.Callbacks.add("Cart.remove.response.success","eShopLogistic3CartRemove",function(e){eShopLogistic.run().then()})))});